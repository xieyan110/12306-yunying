name: Release Pipeline

on:
  create:
    tags:
      - 'v*'       # åŒ¹é… v å¼€å¤´çš„æ ‡ç­¾ (å¦‚ v1.0.0)
  workflow_dispatch:

jobs:
  create_release:
    name: "ğŸ—ƒï¸ï¸ Prepare release"
    permissions:
      contents: write # for actions/create-release to create a release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      release_id: ${{ steps.create_release.outputs.id }}
    steps:
      - uses: actions/checkout@v4
      - name: Create release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.TAG }}
          release_name: Release v${{ env.VERSION }}
          body: ${{ env.RELEASE_TEXT }}
          # we want other build systems to immediately use this release after we uploaded the source archive
          draft: false
          prerelease: false

  build-and-publish-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # è·å–å®Œæ•´å†å²è®°å½•ï¼ŒåŒ…æ‹¬æ ‡ç­¾ä¿¡æ¯

      - name: Get version from tag
        id: get_version
        shell: bash
        run: |
          # æå–æ ‡ç­¾ä¸­çš„ç‰ˆæœ¬å· (å»é™¤å‰ç¼€)
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}  # å»é™¤vå‰ç¼€
          VERSION=${VERSION#release-}  # å»é™¤release-å‰ç¼€
          echo "Extracted version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.2'
          host: 'windows'
          target: 'desktop'
          modules: 'qtcharts qtmultimedia'

      - name: Comment out HAS_CDN using Perl
        shell: bash
        run: perl -i -pe 's/^DEFINES \+= HAS_CDN/# DEFINES += HAS_CDN/' yunying.pro

      # ä»…åœ¨ Windows ä¸Šè®¾ç½® MSVC 2019
      - name: Setup MSVC 2019 (Windows only)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
          toolset: 14.29  # MSVC 2019 (v142)

      # éªŒè¯ MSVC 2019 æ˜¯å¦å¯ç”¨ï¼ˆä»… Windowsï¼‰
      - name: Check cl.exe (Windows only)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          where cl
          cl /?
          if %errorlevel% neq 0 (
            echo "Error: MSVC 2019 (cl.exe) not found!"
            exit /b 1
          )
          echo "MSVC 2019 is ready!"

      - name: Configure with qmake
        run: qmake .

      - name: Build on Windows
        run: nmake

      - name: Package Project
        run: |
          # æ£€æŸ¥ç¼–è¯‘è¾“å‡ºç›®å½•
          ls -la
          if (Test-Path "release\yuny.exe") {
            Copy-Item "release\yuny.exe" .
          } elseif (Test-Path "yuny.exe") {
            Write-Host "yuny.exe found in current directory"
          } else {
            Write-Error "yuny.exe not found! Check compilation output"
            exit 1
          }

          # åˆ›å»ºè¾“å‡ºç›®å½•
          $version = "${{ steps.get_version.outputs.version }}"
          $outputDir = "yuny_$version"
          New-Item -Path $outputDir -ItemType 'Directory' -Force

          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å’Œå›¾æ ‡
          Copy-Item yuny.exe $outputDir
          Copy-Item images\ticket.ico "$outputDir\yuny.ico"

          # ä½¿ç”¨ windeployqt æ”¶é›† Qt ä¾èµ–åº“
          Set-Location $outputDir
          windeployqt yuny.exe

          # ä¸‹è½½å¹¶é…ç½® 7-Zip ç”¨äºæ‰“åŒ…
          Set-Location ..
          New-Item -Path "pkgTemp" -ItemType 'Directory' -Force
          Set-Location "pkgTemp"
          Invoke-WebRequest -Uri "https://github.com/ip7z/7zip/releases/download/25.00/7z2500-x64.exe" -OutFile "7z.exe"
          Invoke-WebRequest -Uri "https://github.com/ip7z/7zip/releases/download/25.00/7z2500-extra.7z" -OutFile "7zip.7z"
          .\7z.exe x 7zip.7z -y

          # å¤åˆ¶ 7-Zip æ–‡ä»¶åˆ°è¾“å‡ºç›®å½•
          Set-Location ..
          Copy-Item "pkgTemp\x64\7za.dll" $outputDir
          Copy-Item "pkgTemp\x64\7za.exe" $outputDir
          Copy-Item "pkgTemp\x64\7zxa.dll" $outputDir

          # æ‰“åŒ…æˆ ZIP æ–‡ä»¶
          $zipFileName = "yuny_$version.zip"
          .\pkgTemp\7z.exe a -tzip $zipFileName $outputDir

          # éªŒè¯ ZIP æ–‡ä»¶
          if (Test-Path $zipFileName) {
            Write-Host "Successfully created $zipFileName"
            Get-Item $zipFileName
          } else {
            Write-Error "Failed to create $zipFileName"
            exit 1
          }

      - name: Publish release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: Release ${{ steps.get_version.outputs.version }}
          body: |
            Automated release created from tag ${{ github.ref }}
            Commit: ${{ github.sha }}
          files: |
            yuny_*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
