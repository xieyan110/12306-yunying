name: Release Pipeline

on:
  create:
    tags:
      - 'v*'       # 匹配 v 开头的标签 (如 v1.0.0)
  workflow_dispatch:

jobs:
  build-and-publish-windows:
    runs-on: windows-latest
    permissions:
      contents: write  # 授予写入权限，用于发布到 GitHub Releases
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # 获取完整历史记录，包括标签信息

      - name: Get version from tag
        id: get_version
        shell: bash
        run: |
          # 提取标签中的版本号 (去除前缀)
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}  # 去除v前缀
          echo "Extracted version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.2'
          host: 'windows'
          target: 'desktop'
          modules: 'qtcharts qtmultimedia'

      - name: Comment out HAS_CDN using Perl
        shell: bash
        run: perl -i -pe 's/^DEFINES \+= HAS_CDN/# DEFINES += HAS_CDN/' yunying.pro

      # 仅在 Windows 上设置 MSVC 2019
      - name: Setup MSVC 2019 (Windows only)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
          toolset: 14.29  # MSVC 2019 (v142)

      # 验证 MSVC 2019 是否可用（仅 Windows）
      - name: Check cl.exe (Windows only)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          where cl
          cl /?
          if %errorlevel% neq 0 (
            echo "Error: MSVC 2019 (cl.exe) not found!"
            exit /b 1
          )
          echo "MSVC 2019 is ready!"

      - name: Configure with qmake
        run: qmake . CONFIG+=Release

      - name: Build on Windows
        run: nmake

      - name: List compilation output
        shell: bash
        run: |
          echo "=== Current directory contents ==="
          ls -la
          echo ""
          echo "=== release directory contents ==="
          if [ -d "release" ]; then
            cd release
            ls -la
            cd ..
          else
            echo "release directory does NOT exist!"
          fi
          echo ""
          echo "=== debug directory contents ==="
          if [ -d "debug" ]; then
            cd debug
            ls -la
            cd ..
          else
            echo "debug directory does NOT exist!"
          fi
          echo ""
          echo "=== All yuny-related files ==="
          find . -name "*yuny*"
          echo ""

      - name: Package Project
        shell: bash
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          OUTPUT_DIR="yuny_$VERSION"
          mkdir -p $OUTPUT_DIR

          # 从 release 目录复制 yuny.exe
          EXE_PATH="./release/yuny.exe"
          if [ -f "$EXE_PATH" ]; then
            echo "Found yuny.exe at: $EXE_PATH"
            cp $EXE_PATH $OUTPUT_DIR
          else
            echo "ERROR: yuny.exe not found in $EXE_PATH!"
            echo "Current directory: $(pwd)"
            echo "Directory contents:"
            ls -la
            if [ -d "release" ]; then
              echo "Release directory contents:"
              ls -la release
            else
              echo "Release directory does NOT exist!"
            fi
            exit 1
          fi

          # 复制图标文件
          cp images/ticket.ico "$OUTPUT_DIR/yuny.ico"

          # 使用 windeployqt 收集 Qt 依赖库
          cd $OUTPUT_DIR
          QT_BIN_PATH="$Qt6_DIR/bin"
          WINDEPLOYQT="$QT_BIN_PATH/windeployqt.exe"
          if [ ! -f "$WINDEPLOYQT" ]; then
            echo "ERROR: windeployqt.exe not found at: $WINDEPLOYQT"
            exit 1
          fi

          echo "Running windeployqt from: $QT_BIN_PATH"
          "$WINDEPLOYQT" yuny.exe
          if [ $? -ne 0 ]; then
            echo "ERROR: windeployqt failed"
            exit 1
          fi

          # 直接使用系统内置的 7-Zip 打包
          cd ..
          ZIP_FILENAME="yuny_$VERSION.zip"
          if command -v 7z >/dev/null 2>&1; then
            echo "Found 7z command"
            7z a -tzip $ZIP_FILENAME $OUTPUT_DIR
          elif command -v "C:\Program Files\7-Zip\7z.exe" >/dev/null 2>&1; then
            echo "Found 7-Zip at C:\Program Files\7-Zip\7z.exe"
            "C:\Program Files\7-Zip\7z.exe" a -tzip $ZIP_FILENAME $OUTPUT_DIR
          elif command -v "C:\Program Files (x86)\7-Zip\7z.exe" >/dev/null 2>&1; then
            echo "Found 7-Zip at C:\Program Files (x86)\7-Zip\7z.exe"
            "C:\Program Files (x86)\7-Zip\7z.exe" a -tzip $ZIP_FILENAME $OUTPUT_DIR
          else
            echo "ERROR: 7-Zip not found on this system!"
            echo "Looking for 7-Zip installation:"
            if [ -d "C:\Program Files\" ]; then
              echo "C:\Program Files\:"
              ls -la "C:\Program Files\" 2>/dev/null
            fi
            if [ -d "C:\Program Files (x86)\" ]; then
              echo "C:\Program Files (x86)\:"
              ls -la "C:\Program Files (x86)\" 2>/dev/null
            fi
            exit 1
          fi

          if [ $? -ne 0 ]; then
            echo "ERROR: 7-Zip packaging failed"
            exit 1
          fi

          # 验证 ZIP 文件
          if [ -f "$ZIP_FILENAME" ]; then
            echo "Successfully created $ZIP_FILENAME"
            ls -lh $ZIP_FILENAME
          else
            echo "ERROR: Failed to create $ZIP_FILENAME"
            exit 1
          fi

      - name: Publish release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ steps.get_version.outputs.version }}
          body: |
            Automated release created from tag ${{ github.ref_name }}
            Commit: ${{ github.sha }}
          files: |
            yuny_*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
